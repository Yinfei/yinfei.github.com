<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Rack and nothing else</title>
  <meta name="description" content="Videogames • Web Development • Cats" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="canonical" href="http://yinfei.github.io/dev/2016/03/01/rack-and-nothing-else.html">

  <link rel="shortcut icon" href="/assets/images/favicon.ico">
<!--  <link rel="stylesheet" href=""> -->
  <link rel="stylesheet" href="http://brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
</head>

  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->

<a href="http://yinfei.github.io" class="logo-readium"><span class="logo" style="background-image: url(/assets/images/venom.png)"></span></a>

<!-- header end -->

    <main class="content" role="main">
      <article class="post">
        
        <div class="article-image">
          <div class="post-image-image" style="background-image: url(/assets/article_images/2016-03-01-rack-and-nothing-else/banner.png)">
            Article Image
          </div>
          <div class="post-meta">
            <h1 class="post-title">Rack and nothing else</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/venom.png)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person">Yohan Piron</h4>
              on
              <time datetime="2016-03-01 22:38">01 Mar 2016</time>
              <!-- , tagged on <span class="post-tag-">, <a href="/tag/"></a></span> -->
            </div>
            <div style="text-align:center">
              <a href="#topofpage" class="topofpage"><i class="fa fa-angle-down"></i></a>
            </div>
          </div>
        </div>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>The main objective of this blogpost will be to build a Ruby werbserver with Rack
as the only gem of our Gemfile and see how far we can go in our app complexity.</p>
<hr />

<h2 id="the-setup">The setup</h2>
<p><br />
I strongly recommend having a Ruby Version manager installed, I personnaly use
<a href="https://github.com/rbenv/rbenv" target="_blank">Rbenv</a>.</p>

<p>First of all, we’ll need at the root of our project a <code class="highlighter-rouge">Gemfile</code> file with those
few lines:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rack'</span>
</code></pre>
</div>
<p><br />
Keep in mind that a <code class="highlighter-rouge">.ruby-version</code> file would be really appreciated by your
Ruby version manager too, just type in there: <code class="highlighter-rouge">2.2.3</code>, or any other Ruby
version of your choice.</p>

<p>Now just run the <code class="highlighter-rouge">bundle install</code> command in your terminal. Our project, at
this step, should look like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/my_project
 - .ruby_version
 - Gemfile
 - Gemfile.lock
</code></pre>
</div>
<hr />

<h2 id="step-1-hello-world">Step 1: Hello world!</h2>
<p><br />
As <a href="http://rack.github.io/">Rack website</a> explains, at the root of our project,
a <code class="highlighter-rouge">config.ru</code> file like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rack'</span>

<span class="n">run</span> <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="p">[</span><span class="s1">'200'</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/html'</span><span class="p">},</span> <span class="p">[</span><span class="s1">'Hello world!'</span><span class="p">]]</span> <span class="p">}</span>
</code></pre>
</div>
<p><br />
can run in a Rack server with a <code class="highlighter-rouge">bundle exec rackup config.ru</code> command in your
terminal.  A quick check at <code class="highlighter-rouge">localhost:9292</code> (9292 being rack default port) in
your browser will show you this :</p>

<p><img src="/assets/article_images/2016-03-01-rack-and-nothing-else/hello_world.png" alt="It works!" /></p>

<p>Now let’s see in details the content of the array our
<a href="http://ruby-doc.org/core-2.2.3/Proc.html" target="_blank">Proc</a> instance gave
to Rack:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">[</span><span class="s1">'200'</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/html'</span><span class="p">},</span> <span class="p">[</span><span class="s1">'Hello world!'</span><span class="p">]]</span>
</code></pre>
</div>
<p><br />
The first item is the HTTP code sent by our server, the second is the headers
sent by the server for the response and the last is the body of the response
itself: in this case plain text.</p>

<p>The next step will be to read an <code class="highlighter-rouge">.erb</code> file! Our project at this point:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/my_project
 - .ruby_version
 - config.ru
 - Gemfile
 - Gemfile.lock
</code></pre>
</div>
<hr />

<h2 id="step-2-lets-read-some-erb-">Step 2: Let’s read some .erb !</h2>
<p><br />
While we’re working with ruby, it would be cool to load erb views. This way we
could use ruby code in it!</p>

<p>Let’s add a <code class="highlighter-rouge">layout.erb</code> view to our project in a <code class="highlighter-rouge">views</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;p&gt;</span>It's <span class="cp">&lt;%=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="s1">'%H:%M'</span><span class="p">)</span> <span class="cp">%&gt;</span>!<span class="nt">&lt;/p&gt;</span>
</code></pre>
</div>

<p><br />
Since we’re lucky, the <code class="highlighter-rouge">ERB</code> class is
<a href="http://ruby-doc.org/stdlib-2.2.3/libdoc/erb/rdoc/ERB.html" target="_blank">part of ruby Standard Lib</a>,
so no need for another gem!</p>

<p>Reading erb content isn’t that hard in fact. In ruby, reading a file can be written like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">file_path</span> <span class="o">=</span> <span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span> <span class="o">+</span> <span class="s1">'/views/index.erb'</span>
<span class="n">file_content</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
</code></pre>
</div>
<p><br />
Render its erb content afterwards would just be something like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">file_content</span><span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
</code></pre>
</div>
<p><br />
In this case <code class="highlighter-rouge">binding</code> will be the result of the erb interpretation done by the <code class="highlighter-rouge">result</code> method call.</p>

<p>Now let’s extract the body response in its own method and implement all of this in our <code class="highlighter-rouge">config.ru</code> :</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rack'</span>
<span class="nb">require</span> <span class="s1">'erb'</span>

<span class="k">def</span> <span class="nf">read_erb_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
  <span class="n">file_content</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>

  <span class="n">erb_load</span> <span class="o">=</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">file_content</span><span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>

  <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="p">[</span><span class="s1">'200'</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/html'</span><span class="p">},</span> <span class="p">[</span><span class="n">erb_load</span><span class="p">]]</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">body</span>
  <span class="n">read_erb_file</span><span class="p">(</span><span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span> <span class="o">+</span> <span class="s1">'/views/index.erb'</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">run</span> <span class="n">body</span>
</code></pre>
</div>
<p><br />
A <code class="highlighter-rouge">bundle exec rackup config.ru</code> command and a look at <code class="highlighter-rouge">localhost:9292</code> will show you this :</p>

<p><img src="/assets/article_images/2016-03-01-rack-and-nothing-else/erb_loaded.png" alt="We load ERB files!" /></p>

<p>Our project at this point is getting bigger:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/my_project
  /views
    - index.erb
 - .ruby_version
 - config.ru
 - Gemfile
 - Gemfile.lock
</code></pre>
</div>
<p><br />
The next step will be to create few more views and dynamically serve them!</p>
<hr />

<h2 id="step-3-more-routes">Step 3: More routes</h2>
<p><br />
Let’s add more views to our project, I’ll just put the files name in their content at this moment
in a dedicated <code class="highlighter-rouge">posts</code> folder:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/my_project
  /views
    - index.erb
  /posts
    - foo.erb
    - bar.erb
 - .ruby_version
 - config.ru
 - Gemfile
 - Gemfile.lock
</code></pre>
</div>
<p><br />
First of all, if we’re to load multiple Procs, we’ll need the
<a href="http://www.rubydoc.info/github/rack/rack/Rack/URLMap" target="_blank">Rack::URLMap</a>
class. It would allow us to load a hash of routes linked to Procs. So, let’s update
our <code class="highlighter-rouge">config.ru</code> file to load those additional views this way. The ugly way would
be to simply update the <code class="highlighter-rouge">body</code> method to declare thoses routes like this :</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">routes</span>
  <span class="p">{</span> <span class="s1">'/'</span>    <span class="o">=&gt;</span> <span class="n">read_erb_file</span><span class="p">(</span><span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span> <span class="o">+</span> <span class="s1">'/views/index.erb'</span><span class="p">),</span>
    <span class="s1">'/foo'</span> <span class="o">=&gt;</span> <span class="n">read_erb_file</span><span class="p">(</span><span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span> <span class="o">+</span> <span class="s1">'/posts/foo.erb'</span><span class="p">),</span>
    <span class="s1">'/bar'</span> <span class="o">=&gt;</span> <span class="n">read_erb_file</span><span class="p">(</span><span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span> <span class="o">+</span> <span class="s1">'/posts/bar.erb'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">run</span> <span class="no">Rack</span><span class="o">::</span><span class="no">URLMap</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">routes</span><span class="p">)</span>
</code></pre>
</div>
<p><br />
Seeing this should scream at you that we should do it dynamically. Doing so would not neccessitate
to update the code to build its route after its addition to the project. Which would be a considerable
waste of time.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">ROOT</span> <span class="o">||=</span> <span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span>
<span class="no">ERB_FILES</span> <span class="o">||=</span> <span class="no">Dir</span><span class="p">[</span><span class="no">ROOT</span> <span class="o">+</span> <span class="s1">'/posts/**/*.erb'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">read_erb_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
  <span class="n">file_content</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>

  <span class="n">erb_load</span> <span class="o">=</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">file_content</span><span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>

  <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="p">[</span><span class="s1">'200'</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/html'</span><span class="p">},</span> <span class="p">[</span><span class="n">erb_load</span><span class="p">]]</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">home</span>
  <span class="p">{</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="n">read_erb_file</span><span class="p">(</span><span class="no">ROOT</span> <span class="o">+</span> <span class="s1">'/views/index.erb'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">relative_file_path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
  <span class="s2">"/</span><span class="si">#{</span><span class="n">file</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/posts\/(.*).erb/</span><span class="p">).</span><span class="nf">captures</span><span class="p">.</span><span class="nf">first</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">routes</span>
  <span class="no">ERB_FILES</span><span class="p">.</span><span class="nf">each_with_object</span><span class="p">(</span><span class="n">home</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="p">,</span> <span class="n">response</span><span class="o">|</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">merge!</span><span class="p">({</span> <span class="n">relative_file_path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">read_erb_file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">})</span>
    <span class="n">response</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">run</span> <span class="no">Rack</span><span class="o">::</span><span class="no">URLMap</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">routes</span><span class="p">)</span>
</code></pre>
</div>
<p><br />
We added few constants in order to make it DRYish.
As you can see, the only specific case here is the homepage which is spearated in its own method.
The rest of the routes will be mapped to an url matching their path in the <code class="highlighter-rouge">posts</code> folder, thanks to
the <code class="highlighter-rouge">relative_file_path</code> method.</p>

<p>This way, we have our homepage on <code class="highlighter-rouge">localhost:9292</code>, and the two other views are accessible at <code class="highlighter-rouge">/foo</code>
and <code class="highlighter-rouge">/bar</code>! But you may wonder why I kept the homepage separated. The next step will make more sense
since we’re going to build a layout system!</p>
<hr />

<h2 id="step-4-lets-create-a-layout-system">Step 4: Let’s create a layout system!</h2>
<p><br />
First things first, let’s add a <code class="highlighter-rouge">layout</code> file in our views:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/my_project
  /views
    - layout.erb
    - index.erb
  /posts
    - foo.erb
    - bar.erb
 - .ruby_version
 - config.ru
 - Gemfile
 - Gemfile.lock
</code></pre>
</div>
<p><br />
Now things are getting serious since, as you may have already found, a layout system would basically
rely on the fact that we’re going to insert the content of an erb file… in another erb file. It may
sound complicated but it can be summed up quite simply.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">LAYOUT</span> <span class="o">||=</span> <span class="no">ROOT</span> <span class="o">+</span> <span class="s1">'/views/layout.erb'</span>

<span class="k">def</span> <span class="nf">erb</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
  <span class="n">params</span> <span class="o">=</span> <span class="n">render_partial</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

  <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">LAYOUT</span><span class="p">)).</span><span class="nf">result</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="nf">instance_eval</span> <span class="p">{</span> <span class="nb">binding</span> <span class="p">})</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">render_partial</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
  <span class="k">return</span> <span class="no">OpenStruct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">content: </span><span class="kp">nil</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="p">.</span><span class="nf">nil?</span>

  <span class="n">path</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

  <span class="no">OpenStruct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">content: </span><span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">path</span><span class="p">)).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">load_erb</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
  <span class="n">render</span> <span class="o">=</span> <span class="n">erb</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

  <span class="no">Proc</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="p">[</span><span class="s1">'200'</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/html'</span><span class="p">},</span> <span class="p">[</span><span class="n">render</span><span class="p">]]</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p><br />
For this case, we have to split the rendering logic. The <code class="highlighter-rouge">render_partial</code> method has been updated, it will
be in charge of loading the post content file and its <code class="highlighter-rouge">.erb</code> content. We eventually add a guard condition
in its first line in case of a user calling a post that does not exist, preventing a crash of the application.</p>

<p>The <code class="highlighter-rouge">erb</code> method is really interesting, it’ll handle the merge of the two ERBs.
First things first, as you can see in its last line, it’ll load the layout file. Then, in this content, we
embed an <code class="highlighter-rouge">instance_eval</code> of the partial rendering and return the whole result as a <code class="highlighter-rouge">binding</code>, same as before.
This time the <code class="highlighter-rouge">instance_eval</code> contains an <code class="highlighter-rouge">OpenStruct</code> with a key named <code class="highlighter-rouge">content</code>, this key has the whole
partial content.</p>

<p>A view of the <code class="highlighter-rouge">layout.erb</code> file may make this clearer as how you’ll load this content in your layout:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;&lt;head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;h1&gt;</span>This is the layout.<span class="nt">&lt;/h1&gt;</span>
        <span class="err">&lt;</span>%= content %&gt;
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>
<p><br />
As I’ve said before, even if it sounds complicated, keep in mind that it’s just embedding an <code class="highlighter-rouge">erb</code> rendering
into another. You can now load any post file in your layout and add new posts on the fly with no sweat!</p>

<p>The next step will be dedicated to strenghten our application by preventing unexpected behaviours.</p>
<hr />

<h2 id="step-5-prevent-unexpected-behaviours-and-massive-cleanup">Step 5: Prevent unexpected behaviours and massive cleanup!</h2>
<p><br />
Our main issue is that all of our program routes are defined at its launch. Meaning that, with our actual code,
you can’t really redirect a user to a “404 not found” page if this user tries to load an unexisting post. At
this point, you’ll only load an empty layout unfortunately: the content of the partial loading being <code class="highlighter-rouge">nil</code>.</p>

<p>Another issue is that if you check you app logs, you’ll see that your browser requests your favicon to display it
and it raises a 404 too.</p>

<p>So, how can we make this routes system more dynamic and more intelligent? How can we send images files like a favicon?
First of all, let’s create a new view called <code class="highlighter-rouge">404.erb</code> in our <code class="highlighter-rouge">views</code> folder and a <code class="highlighter-rouge">favicon.ico</code> file of your choice
at the root of the project.</p>

<p>Since it’ll be a massive rework, let’s move our code to a proper <code class="highlighter-rouge">app.rb</code> file and update the <code class="highlighter-rouge">config.ru</code>. We’ll add
some namespacing too! (From now on, I’ll name my app <code class="highlighter-rouge">Garnet</code>)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/garnet
  /views
    - layout.erb
    - index.erb
    - 404.erb
  /posts
    - foo.erb
    - bar.erb
 - .ruby_version
 - app.rb
 - config.ru
 - favicon.ico
 - Gemfile
 - Gemfile.lock
</code></pre>
</div>
<p><br />
The <code class="highlighter-rouge">app.rb</code> has been reworked a lot:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rack'</span>
<span class="nb">require</span> <span class="s1">'erb'</span>
<span class="nb">require</span> <span class="s1">'ostruct'</span>

<span class="k">module</span> <span class="nn">Garnet</span>
  <span class="k">class</span> <span class="nc">Application</span>

    <span class="nc">ROOT</span> <span class="o">||=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span><span class="p">)</span>

    <span class="no">SYSTEM_FILES</span> <span class="o">||=</span> <span class="p">{</span> <span class="s1">'layout'</span>    <span class="o">=&gt;</span> <span class="no">ROOT</span> <span class="o">+</span> <span class="s1">'/views/layout.erb'</span><span class="p">,</span>
                       <span class="s1">'favicon'</span>   <span class="o">=&gt;</span> <span class="no">ROOT</span> <span class="o">+</span> <span class="s1">'/favicon.ico'</span><span class="p">,</span>
                       <span class="s1">'homepage'</span>  <span class="o">=&gt;</span> <span class="no">ROOT</span> <span class="o">+</span> <span class="s1">'/views/index.erb'</span><span class="p">,</span>
                       <span class="s1">'not_found'</span> <span class="o">=&gt;</span> <span class="no">ROOT</span> <span class="o">+</span> <span class="s1">'/views/404.erb'</span> <span class="p">}</span>

    <span class="no">HEADERS</span> <span class="o">||=</span> <span class="p">{</span> <span class="s1">'html'</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/html'</span> <span class="p">},</span>
                  <span class="s1">'favicon'</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'image/x-icon'</span><span class="p">,</span>
                                 <span class="s1">'Content-Length'</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">SYSTEM_FILES</span><span class="p">[</span><span class="s1">'favicon'</span><span class="p">]).</span><span class="nf">bytesize</span><span class="p">.</span><span class="nf">to_s</span> <span class="p">}</span> <span class="p">}</span>

    <span class="k">def</span> <span class="nf">erb</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">build_partial</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
      <span class="n">layout</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">SYSTEM_FILES</span><span class="p">[</span><span class="s1">'layout'</span><span class="p">])</span>

      <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">layout</span><span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="nf">instance_eval</span> <span class="p">{</span> <span class="nb">binding</span> <span class="p">})</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">build_partial</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
      <span class="n">content</span> <span class="o">=</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="n">file</span><span class="p">))).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>

      <span class="no">OpenStruct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">content: </span><span class="n">content</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">render_view</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
      <span class="n">file</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="no">ROOT</span><span class="si">}</span><span class="s2">/posts/</span><span class="si">#{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.erb"</span>

      <span class="k">return</span> <span class="n">not_found</span> <span class="k">unless</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

      <span class="p">[</span><span class="s1">'200'</span><span class="p">,</span> <span class="no">HEADERS</span><span class="p">[</span><span class="s1">'html'</span><span class="p">],</span> <span class="p">[</span><span class="n">erb</span><span class="p">(</span><span class="n">file</span><span class="p">)]]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">favicon</span>
      <span class="p">[</span><span class="s1">'200'</span><span class="p">,</span> <span class="no">HEADERS</span><span class="p">[</span><span class="s1">'favicon'</span><span class="p">],</span> <span class="p">[</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">SYSTEM_FILES</span><span class="p">[</span><span class="s1">'favicon'</span><span class="p">])]]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">homepage</span>
      <span class="p">[</span><span class="s1">'200'</span><span class="p">,</span> <span class="no">HEADERS</span><span class="p">[</span><span class="s1">'html'</span><span class="p">],</span> <span class="p">[</span><span class="n">erb</span><span class="p">(</span><span class="no">SYSTEM_FILES</span><span class="p">[</span><span class="s1">'homepage'</span><span class="p">])]]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">not_found</span>
      <span class="p">[</span><span class="s1">'404'</span><span class="p">,</span> <span class="no">HEADERS</span><span class="p">[</span><span class="s1">'html'</span><span class="p">],</span> <span class="p">[</span><span class="n">erb</span><span class="p">(</span><span class="no">SYSTEM_FILES</span><span class="p">[</span><span class="s1">'not_found'</span><span class="p">])]]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="n">endpoint_called</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">).</span><span class="nf">path</span>

      <span class="k">return</span> <span class="n">favicon</span>  <span class="k">if</span> <span class="n">endpoint_called</span> <span class="o">==</span> <span class="s1">'/favicon.ico'</span>
      <span class="k">return</span> <span class="n">homepage</span> <span class="k">if</span> <span class="n">endpoint_called</span> <span class="o">==</span> <span class="s1">'/'</span>

      <span class="n">render_view</span><span class="p">(</span><span class="n">endpoint_called</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<p><br />
The real focus here is on the <code class="highlighter-rouge">call</code> method, It’ll get each path request and act
as a proper router. There’s two guard conditions: the first is related to the favicon
that’ll be requested at each call. Doing so allow us to send it as fast as possble in
the whole app process. The second is related to the homepage that can’t match our
dynamic route building unfortunately.</p>

<p>Since <code class="highlighter-rouge">call</code> is in fact a method call by <code class="highlighter-rouge">Rack::Handler::WEBrick</code> triggered automatically
which renders views for us, we’ll cheat a little an use its magic by simply implementing it.
This way we still rely only on <code class="highlighter-rouge">Rack</code> while doing fancy things.</p>

<p>The rest of the rework, as you can see, is just a cleanup in order to keep our project
as DRYish as possible.</p>

<p><code class="highlighter-rouge">config.ru</code> now calls a new instance of Garnet, as expected, binded on the port 3000 now
(which is a personal preference and not really neccessary).</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'./app'</span>

<span class="n">app</span> <span class="o">=</span> <span class="no">Garnet</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">new</span>

<span class="no">Rack</span><span class="o">::</span><span class="no">Handler</span><span class="o">::</span><span class="no">WEBrick</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="no">Port</span><span class="p">:</span> <span class="mi">3000</span><span class="p">)</span>
</code></pre>
</div>
<hr />

<h2 id="last-step-add-some-css">Last step: Add some CSS!</h2>
<p><br />
One last thing: loading asset files! Since dealing with blank views is not quite appealing, let’s
add some style and update our code base to load asset files from a, <code class="highlighter-rouge">asset</code> folder at the root of
our app.</p>

<p>Just update <code class="highlighter-rouge">app.rb</code> to match this, it’s as simple as it sounds:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">asset_file</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="n">file</span> <span class="o">=</span> <span class="p">[</span><span class="no">ROOT</span><span class="p">,</span> <span class="nb">name</span><span class="p">].</span><span class="nf">join</span>

  <span class="k">return</span> <span class="n">not_found</span> <span class="k">unless</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

  <span class="p">[</span><span class="s1">'200'</span><span class="p">,</span> <span class="no">HEADERS</span><span class="p">[</span><span class="s1">'html'</span><span class="p">],</span> <span class="p">[</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">file</span><span class="p">)]]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
  <span class="n">endpoint_called</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">).</span><span class="nf">path</span>

  <span class="k">return</span> <span class="n">favicon</span> <span class="k">if</span> <span class="n">endpoint_called</span> <span class="o">==</span> <span class="s1">'/favicon.ico'</span>
  <span class="k">return</span> <span class="n">homepage</span> <span class="k">if</span> <span class="n">endpoint_called</span> <span class="o">==</span> <span class="s1">'/'</span>
  <span class="k">return</span> <span class="n">asset_file</span><span class="p">(</span><span class="n">endpoint_called</span><span class="p">)</span> <span class="k">if</span> <span class="n">endpoint_called</span> <span class="o">=~</span> <span class="sr">/\/assets/</span>

  <span class="n">render_view</span><span class="p">(</span><span class="n">endpoint_called</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>
<p><br />
This way, any relative link to a stylesheet can work properly and return all the css you need!
<br /></p>
<hr />

<p>There you go! You can now have a little blog working with only one gem in your Gemfile, as promised!
I hope you found this as interesting as it was funny to do for me and if you want to contribute you
can find the source code on <a href="https://github.com/Yinfei/garnet" target="_blank">GitHub</a>.
Thank you for reading, I hope you learnt some things!</p>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=Rack+and+nothing+else&amp;url=http://yinfei.github.io/dev/2016/03/01/rack-and-nothing-else"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/assets/images/venom.png)">Blog Logo</div>
              <h4>Yohan Piron</h4>
              <p class="bio"></p>
              <hr>
              <p class="published">Published <time datetime="2016-03-01 22:38">01 Mar 2016</time></p>
            </section>
          </div>
          
          <div class="isRight">
            <h5 class="index-headline featured"><span>Supported by</span></h5>
            <footer class="site-footer">
              <section class="poweredby">Proudly published with <a href="http://jekyllrb.com"> Jekyll</a></section>
              <a class="subscribe" href="/feed.xml"> <span class="tooltip"> <i class="fa fa-rss"></i> You should subscribe to my feed.</span></a>
              <div class="inner">
                <section class="copyright">All content copyright <a href="/">Yohan Piron</a> &copy; 2016<br>All rights reserved.</section>
              </div>
            </footer>
          </div>
        </div>
      </article>
      
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'yinfeigithubio';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      
    </main>
    <div class="bottom-closer">
      <div class="background-closer-image"  style="background-image: url(/assets/images/shibuya.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">YinBlog</h1>
        <h2 class="blog-description">Videogames • Web Development • Cats</h2>
        <a href="/" class="btn">Back to Overview</a>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    
      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>


  </body>
</html>
